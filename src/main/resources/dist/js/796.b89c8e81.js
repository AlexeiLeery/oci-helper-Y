"use strict";(self["webpackChunkoci_help_web"]=self["webpackChunkoci_help_web"]||[]).push([[796],{4796:function(e,t,s){s.r(t),s.d(t,{default:function(){return h}});var n=s(6768),o=s(4232);function i(e,t,s,i,c,l){const r=(0,n.g2)("el-scrollbar");return(0,n.uX)(),(0,n.Wv)(r,{class:"scrollbar",ref:"scrollContainer"},{default:(0,n.k6)((()=>[((0,n.uX)(!0),(0,n.CE)(n.FK,null,(0,n.pI)(c.logMessages,((e,t)=>((0,n.uX)(),(0,n.CE)("div",{key:t,class:(0,o.C4)(l.getLogLevelClass(e))},(0,o.v_)(e),3)))),128))])),_:1},512)}s(4114);var c=s(1219),l={data(){return{logMessages:[],ws:null,reconnectAttempts:0,maxReconnectAttempts:5,reconnectDelay:5e3,manualClose:!1,isReconnecting:!1,isUserScrolling:!1}},mounted(){this.initWebSocket(),document.addEventListener("visibilitychange",this.handleVisibilityChange),this.$nextTick((()=>{const e=this.$refs.scrollContainer?.$el.querySelector(".el-scrollbar__wrap");e&&e.addEventListener("scroll",(()=>{const t=20,s=e.scrollHeight-e.scrollTop-e.clientHeight<t;this.isUserScrolling=!s}))}))},beforeUnmount(){this.closeWebSocket(),document.removeEventListener("visibilitychange",this.handleVisibilityChange)},methods:{getLogLevelClass(e){return e.includes("ERROR")?"error-log":e.includes("WARN")?"warn-log":"info-log"},initWebSocket(){if(this.ws&&(this.ws.readyState===WebSocket.OPEN||this.ws.readyState===WebSocket.CONNECTING))return void console.log("WebSocket is already connected or connecting");if(this.isReconnecting)return void console.log("Currently reconnecting, skipping new connection attempt");this.logMessages=[],this.manualClose=!1;const e=sessionStorage.getItem("token"),t=this.$axios.defaults.baseURL.replace(/^http/,"ws").replaceAll("/api",""),s=`${t}/logs?token=${e}`;this.ws=new WebSocket(s),this.ws.onopen=()=>{console.log("WebSocket connected"),(0,c.nk)({message:"WebSocket 连接成功，开始实时推送日志",type:"success",duration:2e3}),this.reconnectAttempts=0,this.isReconnecting=!1,this.startHeartbeat()},this.ws.onmessage=e=>{const t=e.data;this.logMessages.push(t),this.logMessages.length>200&&this.logMessages.shift(),this.scrollToBottom()},this.ws.onerror=e=>{console.error("WebSocket error:",e),this.handleReconnect()},this.ws.onclose=e=>{console.warn("WebSocket closed:",e),this.stopHeartbeat(),this.manualClose||this.handleReconnect()}},scrollToBottom(e=!1){this.$nextTick((()=>{const t=this.$refs.scrollContainer?.$el.querySelector(".el-scrollbar__wrap");if(t){const s=20,n=t.scrollHeight-t.scrollTop-t.clientHeight<s;(e||n)&&(t.scrollTop=t.scrollHeight)}}))},closeWebSocket(){this.ws&&(this.manualClose=!0,this.stopHeartbeat(),this.ws.close(),this.ws=null),this.logMessages=[]},startHeartbeat(){this.heartbeatInterval||(this.heartbeatInterval=setInterval((()=>{this.ws.readyState===WebSocket.OPEN&&this.ws.send("ping")}),3e4))},stopHeartbeat(){this.heartbeatInterval&&(clearInterval(this.heartbeatInterval),this.heartbeatInterval=null)},handleReconnect(){this.isReconnecting||"hidden"===document.visibilityState?console.warn("Already reconnecting or page is hidden, skipping reconnect..."):this.reconnectAttempts>=this.maxReconnectAttempts?console.error("Max reconnect attempts reached. Giving up."):(this.isReconnecting=!0,setTimeout((()=>{this.reconnectAttempts++,console.log(`Reconnecting... (Attempt ${this.reconnectAttempts})`),this.initWebSocket()}),this.reconnectDelay))},handleVisibilityChange(){"hidden"===document.visibilityState?(console.log("Page hidden, closing WebSocket..."),this.stopHeartbeat(),this.closeWebSocket()):"visible"===document.visibilityState&&(console.log("Page visible, reconnecting WebSocket..."),this.initWebSocket())}}},r=s(1241);const a=(0,r.A)(l,[["render",i],["__scopeId","data-v-633a60b4"]]);var h=a}}]);
//# sourceMappingURL=796.b89c8e81.js.map